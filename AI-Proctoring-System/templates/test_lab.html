<!DOCTYPE html>
<html>
<head>
    <title>FaceGuard Test Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .verdict-box { font-size: 24px; font-weight: bold; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px;}
        .v-cheat { background: #ffebee; color: #c62828; border: 2px solid #c62828; }
        .v-normal { background: #e8f5e9; color: #2e7d32; border: 2px solid #2e7d32; }
        #webcam { width: 100%; border-radius: 8px; transform: scaleX(-1); border: 3px solid #333; }
        #snapshot { width: 100%; border-radius: 8px; border: 3px solid #0d6efd; display: none; }
        .metrics-card { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <h2 class="text-center">Test with us ! Human-in-the-Loop Tester</h2>
            <div class="d-flex justify-content-center gap-3 mt-3">
                <div class="metrics-card">Total: <strong>{{ stats.total }}</strong></div>
                <div class="metrics-card">Accuracy: <strong>{{ stats.accuracy }}%</strong></div>
                <div class="metrics-card text-success">TP: {{ stats.tp }} | TN: {{ stats.tn }}</div>
                <div class="metrics-card text-danger">FP: {{ stats.fp }} | FN: {{ stats.fn }}</div>
                <a href="/analytics" class="btn btn-danger ms-3 btn-lg">üõë End Test & View Analytics</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">1. Live Feed</div>
                <div class="card-body text-center">
                    <video id="webcam" autoplay playsinline></video>
                    <button class="btn btn-primary w-100 mt-3 btn-lg" onclick="processFrame()">
                        üì∏ Capture & Analyze
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">2. AI Verdict & Labeling</div>
                <div class="card-body">
                    <div id="loading" class="text-center d-none py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>

                    <div id="result-area" class="d-none">
                        <div id="ai-badge" class="verdict-box">Loading...</div>
                        
                        <div class="text-center mb-3">
                            <img id="snapshot" class="img-fluid">
                            <div class="text-muted mt-2 small" id="detection-details"></div>
                        </div>

                        <hr>
                        <h5 class="text-center mb-3">Is the AI Correct? (Overall Verdict)</h5>
                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100 py-3" onclick="submitLabel('CHEATING')">
                                    Overall: It is **CHEATING** ‚ùå
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success w-100 py-3" onclick="submitLabel('NORMAL')">
                                    Overall: It is **NORMAL** ‚úÖ
                                </button>
                            </div>
                        </div>
                        
                        <hr>
                        <h5 class="text-center mb-3 text-info">Human-in-the-Loop: Individual Labeling</h5>
                        <p class="small text-muted text-center">For each detection, was it *truly* present in the image? (Required for detailed metrics)</p>

                        <div id="individual-labels-form">
                            </div>
                    </div>
                    
                    <div id="placeholder" class="text-center py-5 text-muted">
                        Take a snapshot to see AI analysis...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.createElement('canvas');
    let currentResult = null;
    // NOTE: This variable is passed from the Flask backend via Jinja template
    const detectionLabels = {{ detection_labels | tojson }}; 

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        // Optionally adjust video size after metadata is loaded
        video.onloadedmetadata = function(e) {
             video.play();
        };
    }).catch(err => {
         console.error("The following error occurred: " + err.name);
         alert("Cannot access webcam: " + err.name);
    });

    function createLabelForm(detectionData) {
        const formDiv = document.getElementById('individual-labels-form');
        formDiv.innerHTML = ''; 
        
        let html = '';
        detectionLabels.forEach(label => {
            // Get AI confidence and display it
            const conf = detectionData[label] !== undefined ? (detectionData[label] * 100).toFixed(0) : 0;
            
            html += `
                <div class="row mb-2 align-items-center border-bottom pb-2">
                    <div class="col-6">
                        <strong>${label}</strong> <span class="badge bg-secondary">${conf}% AI Conf</span>
                    </div>
                    <div class="col-6 btn-group" data-label-id="${label}">
                        <input type="radio" class="btn-check" name="human_label_${label}" id="${label}_1" value="1" autocomplete="off">
                        <label class="btn btn-outline-danger btn-sm" for="${label}_1">YES</label>

                        <input type="radio" class="btn-check" name="human_label_${label}" id="${label}_0" value="0" autocomplete="off">
                        <label class="btn btn-outline-success btn-sm" for="${label}_0">NO</label>
                    </div>
                </div>
            `;
        });
        formDiv.innerHTML = html;
    }


    async function processFrame() {
        // UI Updates
        document.getElementById('placeholder').classList.add('d-none');
        document.getElementById('result-area').classList.add('d-none');
        document.getElementById('loading').classList.remove('d-none');

        // Capture
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        // Use scaleX(-1) to flip the image drawn on canvas to match the user's view (optional)
        const context = canvas.getContext('2d');
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imgData = canvas.toDataURL('image/jpeg', 0.8);

        // Send to Backend
        try {
            const res = await fetch('/api/test/process', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image: imgData })
            });
            currentResult = await res.json();
            
            if (currentResult.status === 'error') {
                 alert("Backend Error: " + currentResult.message);
                 return;
            }
        } catch(e) {
             alert("Network Error: Could not connect to backend.");
             return;
        }

        // Update UI with Result
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('result-area').classList.remove('d-none');
        
        const badge = document.getElementById('ai-badge');
        badge.innerText = "AI Verdict: " + currentResult.verdict;
        badge.className = "verdict-box " + (currentResult.verdict === "CHEATING" ? "v-cheat" : "v-normal");

        const snap = document.getElementById('snapshot');
        snap.src = currentResult.image_url;
        snap.style.display = 'block';
        
        // NEW: Populate the individual labeling form
        createLabelForm(currentResult.detection_data);

        // Format details
        let detailsHtml = "<strong>Detections:</strong> ";
        if (currentResult.details.length === 0) detailsHtml += "None";
        else {
            currentResult.details.forEach(d => {
                // Ensure confidence is valid before calling toFixed
                const confPercent = d.confidence && !isNaN(d.confidence) ? (d.confidence * 100).toFixed(0) : 'N/A';
                detailsHtml += `<span class="badge bg-secondary mx-1">${d.type} (${confPercent}%)</span>`;
            });
        }
        document.getElementById('detection-details').innerHTML = detailsHtml;
    }

    async function submitLabel(overall_label) {
        // 1. Collect individual human labels from the form
        const humanLabelData = {};
        let allLabeled = true;
        
        detectionLabels.forEach(label => {
            const checked = document.querySelector(`input[name="human_label_${label}"]:checked`);
            if (!checked) {
                // Must label ALL individual detections for accurate multi-label metrics
                allLabeled = false;
            } else {
                humanLabelData[label] = checked.value;
            }
        });

        if (!allLabeled) {
            alert("Please label ALL individual detections (YES/NO) before submitting the overall verdict.");
            return;
        }

        if (!currentResult) {
            alert("Please capture and analyze a frame first.");
            return;
        }

        // 2. Submit data
        try {
            await fetch('/api/test/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ai_verdict: currentResult.verdict,
                    human_label: overall_label, // This is the overall CHEATING/NORMAL label
                    filename: currentResult.filename,
                    details: currentResult.details,
                    detection_data: currentResult.detection_data, // AI confidences
                    human_label_data: humanLabelData // Individual human labels (1 or 0)
                })
            });
            location.reload(); // Refresh to update stats
        } catch(e) {
            console.error("Submit Error:", e);
            alert("Failed to submit label. Check console for details.");
        }
    }
</script>
</body>
</html>