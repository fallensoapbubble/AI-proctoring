{% extends "layout.html" %}

{% block head %}
<style>
    .results-container {
        max-width: 600px;
        margin: 50px auto;
        text-align: center;
    }
    .score-display {
        font-size: 3rem;
        font-weight: bold;
        margin: 30px 0;
    }
    .score-excellent {
        color: #28a745;
    }
    .score-good {
        color: #17a2b8;
    }
    .score-fair {
        color: #ffc107;
    }
    .score-poor {
        color: #dc3545;
    }
    .session-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h2 class="card-title h4 mb-0">üéâ Exam Completed!</h2>
        </div>
        <div class="card-body">
            <h3>Your Results</h3>
            
            {% set percentage = (score / total * 100) | round(1) %}
            <div class="score-display 
                {% if percentage >= 90 %}score-excellent
                {% elif percentage >= 75 %}score-good
                {% elif percentage >= 60 %}score-fair
                {% else %}score-poor{% endif %}">
                {{ score }} / {{ total }}
                <div style="font-size: 1.5rem;">{{ percentage }}%</div>
            </div>
            
            <div class="session-info">
                <h5>Session Information</h5>
                <p><strong>Session ID:</strong> {{ session.get('session_id', 'Unknown') }}</p>
                <p><strong>Student:</strong> {{ session.get('student_name', 'Unknown') }}</p>
                <p><strong>Student ID:</strong> {{ session.get('student_id', 'Unknown') }}</p>
                <p><strong>Start Time:</strong> {{ session_data.get('start_time', 'Unknown') }}</p>
                <p><strong>End Time:</strong> {{ session_data.get('end_time', 'Unknown') }}</p>
                <p><strong>Status:</strong> {{ session_data.get('status', 'Unknown') }}</p>
            </div>
            
            <!-- Cheating Triggers Section -->
            {% if session_data.get('detections') %}
            <div class="alert alert-danger">
                <h5><strong>üö® CHEATING TRIGGERS DETECTED</strong></h5>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Detection Summary:</h6>
                        <p><strong>Total Violations:</strong> {{ session_data.detections|length }}</p>
                        {% set detection_types = session_data.detections|map(attribute='type')|list %}
                        {% set high_confidence_count = session_data.detections|selectattr('confidence', 'gt', 0.7)|list|length %}
                        <p><strong>High Confidence Violations:</strong> {{ high_confidence_count }}</p>
                        
                        <div class="mt-2">
                            {% set type_counts = {} %}
                            {% for detection in session_data.detections %}
                                {% set clean_type = detection.type|replace('DetectionType.', '')|replace('_', ' ')|title %}
                                {% if clean_type in type_counts %}
                                    {% set _ = type_counts.update({clean_type: type_counts[clean_type] + 1}) %}
                                {% else %}
                                    {% set _ = type_counts.update({clean_type: 1}) %}
                                {% endif %}
                            {% endfor %}
                            {% for detection_type, count in type_counts.items() %}
                            <span class="badge bg-danger me-1 mb-1">{{ detection_type }}: {{ count }}x</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Risk Assessment:</h6>
                        {% set risk_score = (session_data.detections|length * 10) + (high_confidence_count * 15) %}
                        {% if risk_score > 50 %}
                        <div class="alert alert-danger p-2 mb-2">
                            <strong>HIGH RISK</strong> - Multiple violations detected
                        </div>
                        {% elif risk_score > 20 %}
                        <div class="alert alert-warning p-2 mb-2">
                            <strong>MEDIUM RISK</strong> - Some violations detected
                        </div>
                        {% else %}
                        <div class="alert alert-info p-2 mb-2">
                            <strong>LOW RISK</strong> - Few violations detected
                        </div>
                        {% endif %}
                        <small class="text-muted">Risk Score: {{ risk_score }}/100</small>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-success">
                <strong>‚úÖ CLEAN SESSION:</strong> No cheating triggers detected during the exam.
            </div>
            {% endif %}
            
            <!-- File Summary -->
            {% if file_counts %}
            <div class="session-info">
                <h6>Session Files Generated:</h6>
                <div class="row">
                    <div class="col-md-4">
                        <p><strong>Screenshots:</strong> {{ file_counts.get('screenshots', 0) }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Audio Files:</strong> {{ file_counts.get('audio', 0) }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Answers:</strong> {{ file_counts.get('answers', 0) }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Detection Details - Show ALL detections -->
            {% if session_data.get('detections') %}
            <div class="mt-4">
                <h6>Detection Timeline (All {{ session_data.detections|length }} Events):</h6>
                <div class="list-group" style="max-height: 500px; overflow-y: auto;">
                    {% for detection in session_data.detections %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <h6 class="mb-1">
                                {% if 'GAZE' in detection.type %}üëÅÔ∏è
                                {% elif 'MOBILE' in detection.type %}üì±
                                {% elif 'PEOPLE' in detection.type %}üë•
                                {% elif 'FACE' in detection.type %}üò∂
                                {% elif 'LIP' in detection.type %}üëÑ
                                {% elif 'SPEECH' in detection.type %}üó£Ô∏è
                                {% else %}‚ö†Ô∏è{% endif %}
                                {{ detection.type|replace('DetectionType.', '')|replace('_', ' ')|title }}
                            </h6>
                            <small class="text-muted">{{ detection.timestamp[:19]|replace('T', ' ') }}</small>
                        </div>
                        <p class="mb-1">
                            <span class="badge {% if detection.confidence > 0.7 %}bg-danger{% elif detection.confidence > 0.5 %}bg-warning{% else %}bg-secondary{% endif %}">
                                Confidence: {{ "%.1f"|format(detection.confidence * 100) }}%
                            </span>
                        </p>
                        <small class="text-muted">Source: {{ detection.source }}</small>
                    </div>
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">‚úì Showing all {{ session_data.detections|length }} detection events chronologically</small>
            </div>
            {% endif %}
            
            <!-- Cheating Evidence Display -->
            <div class="mt-4" id="cheating-evidence">
                <h5><strong>üîç CHEATING EVIDENCE</strong></h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">üì∏ Visual Evidence (Screenshots)</h6>
                            </div>
                            <div class="card-body" id="screenshots-container">
                                <p class="text-muted">Loading visual evidence...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">üéµ Audio Evidence (Recorded During Cheating)</h6>
                            </div>
                            <div class="card-body" id="audio-container">
                                <p class="text-muted">Loading audio evidence...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <strong>Note:</strong> Your exam session has been recorded and will be reviewed. 
                All session data including screenshots, audio recordings, and detection events have been saved for verification purposes.
            </div>
            
            <div class="mt-4">
                <a href="/" class="btn btn-primary">Return to Home</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
    // Load session files when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Try multiple sources for session ID
        let sessionId = '{{ session_data.get("session_id", "") }}';
        
        // Fallback to Flask session if session_data doesn't have it
        if (!sessionId || sessionId === '') {
            sessionId = '{{ session.get("session_id", "") }}';
        }
        
        console.log('=== SESSION DEBUG ===');
        console.log('Session ID from session_data:', '{{ session_data.get("session_id", "NOT_FOUND") }}');
        console.log('Session ID from Flask session:', '{{ session.get("session_id", "NOT_FOUND") }}');
        console.log('Final session ID:', sessionId);
        console.log('Session data keys:', Object.keys({{ session_data | tojson }}));
        console.log('====================');
        
        if (sessionId && sessionId !== '' && sessionId !== 'NOT_FOUND') {
            console.log('‚úÖ Loading session files for:', sessionId);
            loadSessionFiles(sessionId);
        } else {
            console.error('‚ùå No valid session ID found');
            const errorMsg = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> No session ID available. 
                    <br><small>Session data: ${JSON.stringify({{ session_data | tojson }})}</small>
                </div>
            `;
            document.getElementById('screenshots-container').innerHTML = errorMsg;
            document.getElementById('audio-container').innerHTML = errorMsg;
        }
    });
    
    async function loadSessionFiles(sessionId) {
        try {
            console.log('Fetching session files for:', sessionId);
            const response = await fetch(`/api/session_files/${sessionId}`);
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            const files = await response.json();
            console.log('Session files response:', files);
            
            if (response.ok) {
                console.log('Screenshots found:', files.screenshots.length);
                console.log('Audio files found:', files.audio.length);
                
                // Log each screenshot URL for debugging
                files.screenshots.forEach((screenshot, index) => {
                    console.log(`Screenshot ${index + 1}: ${screenshot.filename} -> ${screenshot.url}`);
                });
                
                displayScreenshots(files.screenshots);
                displayAudioFiles(files.audio);
            } else {
                console.error('Error loading session files:', files.error);
                document.getElementById('screenshots-container').innerHTML = `<p class="text-danger">Error: ${files.error}</p>`;
                document.getElementById('audio-container').innerHTML = `<p class="text-danger">Error: ${files.error}</p>`;
            }
        } catch (err) {
            console.error('Error loading session files:', err);
            document.getElementById('screenshots-container').innerHTML = `<p class="text-danger">Network error: ${err.message}</p>`;
            document.getElementById('audio-container').innerHTML = `<p class="text-danger">Network error: ${err.message}</p>`;
        }
    }
    
    function displayScreenshots(screenshots) {
        const container = document.getElementById('screenshots-container');
        console.log('Displaying screenshots:', screenshots);
        
        if (!screenshots || screenshots.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> No visual violations captured
                </div>
            `;
            return;
        }
        
        // Sort screenshots by filename (which contains timestamp) to show chronologically
        screenshots.sort((a, b) => a.filename.localeCompare(b.filename));
        
        let html = `
            <div class="alert alert-danger mb-3">
                <strong><i class="fas fa-camera"></i> ${screenshots.length} violation screenshot(s) captured!</strong>
                <br><small>These images show moments when cheating behavior was detected.</small>
            </div>
            <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
        `;
        
        html += '<div class="row">';
        
        // Show ALL screenshots - no limit
        screenshots.forEach((screenshot, index) => {
            const sizeKB = Math.round(screenshot.size / 1024);
            
            // Extract and format timestamp properly
            const timestampMatch = screenshot.filename.match(/(\d{8})_(\d{6})/);
            let formattedTime = 'Unknown';
            if (timestampMatch) {
                const dateStr = timestampMatch[1]; // YYYYMMDD
                const timeStr = timestampMatch[2]; // HHMMSS
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const hour = timeStr.substring(0, 2);
                const minute = timeStr.substring(2, 4);
                const second = timeStr.substring(4, 6);
                formattedTime = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
            }
            
            // Determine detection type from filename
            const detectionType = screenshot.filename.includes('gaze') ? 'Looking Away' :
                                 screenshot.filename.includes('mobile') ? 'Mobile Device' :
                                 screenshot.filename.includes('people') ? 'Multiple People' :
                                 screenshot.filename.includes('face') ? 'Face Not Visible' :
                                 screenshot.filename.includes('lips') ? 'Lip Movement' : 'Suspicious Activity';
            
            console.log(`Screenshot ${index + 1}:`, screenshot.url);
            
            // Escape quotes in URL and filename for onclick handlers
            const escapedUrl = screenshot.url.replace(/'/g, "\\'");
            const escapedFilename = screenshot.filename.replace(/'/g, "\\'");
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white p-2">
                            <small><strong>${detectionType}</strong></small>
                        </div>
                        <img src="${screenshot.url}" class="card-img-top" style="height: 150px; object-fit: cover; cursor: pointer;" 
                             alt="Violation Evidence ${index + 1}" onclick="showImageModal('${escapedUrl}', '${escapedFilename}')"
                             onerror="handleImageError(this, '${escapedFilename}')">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">${formattedTime}</small>
                                <span class="badge bg-danger">${sizeKB} KB</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary w-100" onclick="showImageModal('${escapedUrl}', '${escapedFilename}')">
                                <i class="fas fa-search-plus"></i> View Evidence
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>'; // Close row and scrollable container
        
        if (screenshots.length > 5) {
            html += `<p class="small text-danger mt-2"><strong>‚ö†Ô∏è Showing all ${screenshots.length} screenshots - High risk session!</strong></p>`;
        } else {
            html += `<p class="small text-muted mt-2">‚úì Showing all ${screenshots.length} screenshot(s)</p>`;
        }
        
        console.log('‚úÖ Setting screenshots HTML - total images:', screenshots.length);
        container.innerHTML = html;
    }
    
    function displayAudioFiles(audioFiles) {
        const container = document.getElementById('audio-container');
        
        if (audioFiles.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> No audio evidence recorded
                </div>
            `;
            return;
        }
        
        // Sort audio files by filename (which contains timestamp) to show chronologically
        audioFiles.sort((a, b) => a.filename.localeCompare(b.filename));
        
        let html = `
            <div class="alert alert-warning mb-3">
                <strong><i class="fas fa-exclamation-triangle"></i> ${audioFiles.length} audio recording(s) captured during cheating triggers!</strong>
                <br><small>Audio was automatically recorded when suspicious behavior was detected.</small>
            </div>
            <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
        `;
        
        // Show ALL audio files - no limit
        const displayFiles = audioFiles;
        
        displayFiles.forEach((audioFile, index) => {
            const sizeKB = Math.round(audioFile.size / 1024);
            
            // Extract and format timestamp properly
            const timestampMatch = audioFile.filename.match(/(\d{8})_(\d{6})/);
            let formattedTime = 'Unknown';
            let detectionType = 'Suspicious Activity';
            let detectionIcon = '‚ö†Ô∏è';
            
            if (timestampMatch) {
                const dateStr = timestampMatch[1]; // YYYYMMDD
                const timeStr = timestampMatch[2]; // HHMMSS
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                const hour = timeStr.substring(0, 2);
                const minute = timeStr.substring(2, 4);
                const second = timeStr.substring(4, 6);
                formattedTime = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
            }
            
            // Determine detection type from filename
            if (audioFile.filename.includes('lip_movement')) {
                detectionType = 'Lip Movement Detected';
                detectionIcon = 'üëÑ';
            } else if (audioFile.filename.includes('mobile_detected')) {
                detectionType = 'Mobile Device Detected';
                detectionIcon = 'üì±';
            } else if (audioFile.filename.includes('multiple_people')) {
                detectionType = 'Multiple People Detected';
                detectionIcon = 'üë•';
            } else if (audioFile.filename.includes('gaze_away')) {
                detectionType = 'Looking Away';
                detectionIcon = 'üëÅÔ∏è';
            } else if (audioFile.filename.includes('suspicious_speech')) {
                detectionType = 'Suspicious Speech';
                detectionIcon = 'üó£Ô∏è';
            }
            
            // Determine audio format from file extension
            const fileExt = audioFile.filename.split('.').pop().toLowerCase();
            const audioType = fileExt === 'mp3' ? 'audio/mpeg' : fileExt === 'ogg' ? 'audio/ogg' : 'audio/wav';
            const formatBadge = fileExt.toUpperCase();
            
            html += `
                <div class="mb-3">
                    <div class="card border-warning">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-danger">
                                    <i class="fas fa-microphone"></i> ${detectionIcon} ${detectionType}
                                </h6>
                                <div>
                                    <span class="badge bg-info text-white me-1">${formatBadge}</span>
                                    <span class="badge bg-warning text-dark">${sizeKB} KB</span>
                                </div>
                            </div>
                            <small class="text-muted">Recorded: ${formattedTime}</small>
                        </div>
                        <div class="card-body p-3">
                            <div class="alert alert-danger p-2 mb-2">
                                <small><strong>‚ö†Ô∏è CHEATING TRIGGER:</strong> Audio was recorded when ${detectionType.toLowerCase()} was detected</small>
                            </div>
                            <audio controls class="w-100 mb-2" preload="metadata">
                                <source src="${audioFile.url}" type="${audioType}">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">File: ${audioFile.filename}</small>
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadAudio('${audioFile.url}', '${audioFile.filename}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>'; // Close scrollable container
        
        if (audioFiles.length > 10) {
            html += `<p class="small text-warning mt-2"><strong>‚ö†Ô∏è Showing all ${audioFiles.length} audio files - High risk session!</strong></p>`;
        } else {
            html += `<p class="small text-warning mt-2"><strong>‚úì Showing all ${audioFiles.length} audio files</strong></p>`;
        }
        
        console.log('‚úÖ Setting audio HTML - total files:', audioFiles.length);
        container.innerHTML = html;
    }
    
    function downloadAudio(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function handleImageError(img, filename) {
        console.error('‚ùå Failed to load image:', img.src, 'for file:', filename);
        
        // Test if the URL is accessible
        fetch(img.src)
            .then(response => {
                console.log(`Image fetch test for ${filename}:`, response.status, response.statusText);
                if (!response.ok) {
                    console.error(`Server returned ${response.status} for ${filename}`);
                }
            })
            .catch(err => {
                console.error(`Network error fetching ${filename}:`, err);
            });
        
        // Prevent infinite loop
        img.onerror = null;
        
        // Replace the image with a div showing error
        const errorDiv = document.createElement('div');
        errorDiv.className = 'card-img-top d-flex align-items-center justify-content-center flex-column p-2';
        errorDiv.style.height = '120px';
        errorDiv.style.backgroundColor = '#f8f9fa';
        errorDiv.style.border = '2px dashed #dee2e6';
        errorDiv.style.color = '#6c757d';
        errorDiv.innerHTML = `
            <small><strong>Image failed to load</strong></small>
            <small class="text-muted mt-1">${filename}</small>
            <small class="text-danger mt-1">Check console for details</small>
        `;
        
        img.parentNode.replaceChild(errorDiv, img);
    }
    
    function showImageModal(imageUrl, filename) {
        // Create modal for full-size image viewing
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${filename}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" class="img-fluid" alt="${filename}" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display:none; padding: 50px; color: #6c757d;">
                            <p>Failed to load image: ${filename}</p>
                            <small>URL: ${imageUrl}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
</script>
{% endblock %}